- const { server, site, visitor, option } = theme.artalk
- const { use, lazyload, count } = theme.comments

script.
  (() => {
    const init = () => {
      window.artalkItem = Artalk.init(Object.assign({
        el: '#artalk-wrap',
        pageKey: window.location.pathname,
        pageTitle: document.title,
        server: '!{server}',
        site: '!{site}',
      }, !{JSON.stringify(option || {})}))

      window.artalkItem.on('list-loaded', () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#artalk-wrap .atk-content img:not(.atk-emoticon)'))
      })
    }

    const loadArtalk = () => {
      if (typeof Artalk === 'function') setTimeout(init, 0)
      else {
        getCSS('!{url_for(theme.asset.artalk_css)}')
        getScript('!{url_for(theme.asset.artalk_js)}').then(init)
      }
    }

    const getCount = () => {
      const countElement = document.getElementById('artalk-count')
      if (!countElement) return
      
      fetch(`!{server}/api/v2/pages/pv?page_key=${encodeURIComponent(window.location.pathname)}&site_name=!{site}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.pv !== undefined) {
            countElement.textContent = data.pv
          }
        })
        .catch(err => console.error('Artalk PV fetch error:', err))
    }

    if ('!{use[0]}' === 'Artalk' || !!{lazyload}) {
      if (!{lazyload}) anzhiyu.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
      else setTimeout(loadArtalk, 0)
    } else {
      window.loadOtherComment = loadArtalk
    }

    if (!!{visitor} && GLOBAL_CONFIG_SITE.isPost) {
      getCount()
    }
  })()
